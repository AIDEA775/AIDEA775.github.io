<!DOCTYPE html>
<html lang="es">
<head>
  
    <title>
      
        Linux Mainline en CHIP :: El blog de AIDEA775
      </title>
  
  <meta charset="utf-8">
<meta name="generator" content="Hugo 0.57.2" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="/css/arst.css" type="text/css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/themes/prism-okaidia.min.css" rel="stylesheet" />
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="El blog de AIDEA775">
<link id="favicon" rel="icon" href="/favicon.png" type="image/png" sizes="16x16">
</head>
<body>
  <div class="container center">

    
      <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/es">
  <div class="logo">
    AIDEA775 en español
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Más ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/es/about">Sobre mí</a></li>
              
            
          </ul>
        </ul>
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/es/about">Sobre mí</a></li>
      
    
  </ul>
</nav>

  
</header>

    

    

<div class="post">
  <main role="main" class="article">
      <article class="single" itemscope itemtype="http://schema.org/BlogPosting">

        
        <h1 class="post-title headline">
          <a href="https://blog.aidea775.com/es/guides/chip-mainline-kernel/">Linux Mainline en CHIP</a>
        </h1>

        <div class="meta">
          
  <span class="key">published on</span>
  <span class="val">
    <time itemprop="datePublished" datetime="2019-08-16">
      August 16, 2019
    </time>
  </span>

          
  <span class="key">in</span>
  <span class="val">
    <a href="https://blog.aidea775.com/es/guides">guides</a>
  </span>


          

          
        </div>

        <section class="body" itemprop="articleBody">
          

<p>En este texto cuento como fue el proceso que llevé a cabo para compilar
<em>linux mainline</em> para la CHIP desde la primera vez que la enchufé.</p>

<p>CHIP es una computadora <em>single-board</em> fabricada por Next Thing Co. (NTC),
lanzado como <em>open-source hardware</em> corriendo <em>open-source software</em>.
Fue anunciado como &ldquo;la primera computadora del mundo de $ 9&rdquo;. Mas info en
<a href="https://en.wikipedia.org/wiki/CHIP_(computer)">Wikipedia</a>.</p>

<aside>
    <nav id="TableOfContents">
<ul>
<li><a href="#flasheando">Flasheando</a>
<ul>
<li><a href="#compilar">Compilar</a></li>
<li><a href="#mover">Mover</a></li>
</ul></li>
<li><a href="#conectando">Conectando</a></li>
<li><a href="#booteando">Booteando</a>
<ul>
<li><a href="#rootfs">Rootfs</a></li>
<li><a href="#nfs">NFS</a></li>
<li><a href="#ips">IPs</a></li>
<li><a href="#recompilar">Recompilar</a></li>
<li><a href="#bootear-posta">Bootear posta</a></li>
</ul></li>
</ul>
</nav>
</aside>

<h1 id="flasheando">Flasheando</h1>

<p>La primera vez que alimenté a la CHIP los leds prendian, pero no tenía salida
de video. Usé el script de la siguiente guía para flashearla.</p>

<p><a href="http://www.chip-community.org/index.php/Flash_from_command_line">http://www.chip-community.org/index.php/Flash_from_command_line</a></p>

<p>Otra guía para flashear sin conexión y en español (por Alejandro Gaut):
<a href="https://gitlab.com/snippets/1866690">https://gitlab.com/snippets/1866690</a></p>

<p>Luego de flashearla, los leds empezaron a parpadear,
pero seguía sin video, a prueba y error, descubrí que debía conectar la
salida de audio R del RCA (roja) a la entrada de video (amarilla).</p>

<p>Una vez que el Debian de NTC booteó, y luego de jugar un buen rato a
<a href="https://www.youtube.com/watch?v=cP1x_EypI6Q">Celeste Classic</a>,
empecé a compilar linux mainline.</p>

<h2 id="compilar">Compilar</h2>

<p>Pasos sacados de <a href="http://www.chip-community.org/index.php/Compile_the_Linux_kernel_for_CHIP">aqui</a>.</p>

<p>Cross compiling toolchain:</p>

<pre><code class="language-bash">sudo apt-get install gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
</code></pre>

<p>Linux Mainline:</p>

<pre><code class="language-bash">git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
# sino sólo el último commit
git clone --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</code></pre>

<p>Kernel config:</p>

<pre><code class="language-bash">cp arch/arm/configs/sunxi_defconfig .config
</code></pre>

<p>Configurar kernel:</p>

<pre><code class="language-bash">make ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf- menuconfig
</code></pre>

<p>No se si esto es tan importante:</p>

<blockquote>
<p>IMPORTANT: add a local version suffix. Follow the menus:</p>

<pre><code class="language-none">    General setup  ---&gt;
    () Local version - append to kernel release
</code></pre>
</blockquote>

<p>Compilar kernel:</p>

<pre><code class="language-bash">make -j13 ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf-
</code></pre>

<blockquote>
<p>El parametro -j debería ser el numero de cores de tu procesador + 1.</p>
</blockquote>

<p>Modulos (tal vez esto no sea necesario):</p>

<pre><code class="language-bash">export WORKSPACE=./build
make ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf- INSTALL_MOD_PATH=$WORKSPACE modules_install
</code></pre>

<p>Esto instalará los modulos en <code>$WORKSPACE/lib</code> (después será copiado a la CHIP).</p>

<h2 id="mover">Mover</h2>

<p>Elimina los symlinks <code>build</code> y <code>source</code> de <code>lib/</code> porque <code>[s]cp -r</code> los seguirá.</p>

<pre><code class="language-bash">export RELEASE=5.2.0-rc1vv1
unlink lib/modules/$RELEASE/build
unlink lib/modules/$RELEASE/source
</code></pre>

<p>Ahora tendrás que <strong>configurar un servidor ssh en la CHIP</strong>,
no debería ser muy complicado.</p>

<p>Copiá todo a un directorio temporal a la CHIP:</p>

<pre><code class="language-bash">scp arch/arm/boot/dts/sun5i-r8-chip.dtb chip@chip:tmp
scp -r build/lib/modules/$RELEASE arch/arm/boot/zImage .config System.map chip@chip:tmp
</code></pre>

<p>Y luego movelo a donde corresponda:</p>

<table>
<thead>
<tr>
<th>workspace source location</th>
<th>destination on CHIP</th>
</tr>
</thead>

<tbody>
<tr>
<td>arch/arm/boot/zImage</td>
<td>/boot/vmlinuz-$RELEASE</td>
</tr>

<tr>
<td>.config</td>
<td>/boot/config-$RELEASE</td>
</tr>

<tr>
<td>System.map</td>
<td>/boot/System.map-$RELEASE</td>
</tr>

<tr>
<td>lib/modules/$RELEASE</td>
<td>/lib/modules/$RELEASE</td>
</tr>
</tbody>
</table>

<h1 id="conectando">Conectando</h1>

<p>Pasos sacado de <a href="http://www.chip-community.org/index.php/Chip9$_U-Boot:_how_to_test_a_new_kernel_(in_a_safe_way)#You_need_.28UART1.29_console_access.21">aquí</a>.</p>

<p>Necesitamos un cable USB-UART y conectarlo como se debe. (TODO: Agregar foto)</p>

<ul>
<li>Ground pin 1</li>
<li>TX pin 3</li>
<li>RX pin 5</li>
</ul>

<p><strong>CABLE ROJO NO, nada de +5v.</strong></p>

<p>Luego instalar screen:</p>

<pre><code class="language-bash">sudo apt-get install screen
</code></pre>

<p>Conecta el lado del USB a la pc, y lanza screen:</p>

<pre><code class="language-bash">screen /dev/ttyUSB0 115200
</code></pre>

<p>Chequeá la salida de <code>ls /dev/tty*</code> antes y despues de conectar la CHIP para
encontar el archivo correcto.</p>

<blockquote>
<p>Si te sale <code>screen is terminating error</code>, probá con:</p>

<pre><code class="language-bash">sudo screen /dev/ttyUSB0 115200
</code></pre>
</blockquote>

<p>Ahora bootea tu CHIP (conectala a la alimentación).</p>

<p>Tenes 3 segundos para parar el proceso de booteo y tener acceso a la shell de u-boot.</p>

<pre><code class="language-none">U-Boot SPL 2016.01-00088-g99c771f (Dec 09 2016 - 22:29:06)
DRAM: 512 MiB
CPU: 1008000000Hz, AXI/AHB/APB: 3/2/2
Trying to boot from NAND


U-Boot 2016.01-00088-g99c771f (Dec 09 2016 - 22:29:06 +0000) Allwinner Technology

CPU:   Allwinner A13 (SUN5I)
I2C:   ready
DRAM:  512 MiB
NAND:  8192 MiB
video-mode 720x480-24@60 not available, falling back to 1024x768-24@60
Setting up a 720x480i composite-ntsc console (overscan 40x20)
In:    serial
Out:   serial
Err:   serial
Net:   usb_ether
starting USB...
No controllers found
Hit any key to stop autoboot:  0
=&gt;
</code></pre>

<h1 id="booteando">Booteando</h1>

<p>La memoria NAND MLC que tiene la CHIP no está soportada en Linux Mainline.
Por lo que lo siguiente va a tirar kernel panic porque no encuentra un <code>rootfs</code>.</p>

<p>Pero, técnicamente, Linux arranca.</p>

<p>La solución, es bootear con un rootfs a través de NFS por usb, en modo usb-device-ethernet,
que está en la siguiente sección.</p>

<p>Los pasos para bootear serían:</p>

<pre><code class="language-shell">editenv bootcmd
# cambiar `for path in ${bootpaths}; do run boot_$path; done` por `run boot_noinitrd`
editenv boot_noinitrd
# cambiar el path del kernel `/boot/zImage` a `/boot/vmlinuz-$RELEASE`
run boot
</code></pre>

<p>Para copypastear (cambiá el valor de <code>$RELEASE</code>):</p>

<pre><code class="language-shell">setenv bootcmd &quot;run test_fastboot; if test -n ${fel_booted} &amp;&amp; test -n ${scriptaddr}; then echo (FEL boot); source ${scriptaddr}; fi; run boot_noinitrd&quot;
setenv boot_noinitrd &quot;mtdparts; ubi part UBI; ubifsmount ubi0:rootfs; ubifsload $fdt_addr_r /boot/sun5i-r8-chip.dtb; ubifsload $kernel_addr_r /boot/vmlinuz-$RELEASE; bootz $kernel_addr_r - $fdt_addr_r&quot;
run boot
</code></pre>

<h2 id="rootfs">Rootfs</h2>

<p>Usé debootstrap:</p>

<pre><code class="language-bash">sudo apt install debootstrap
</code></pre>

<p>Generar el rootfs para la CHIP (armhf = 32bits):</p>

<pre><code class="language-bash">mkdir /nfs/chip
cd /nfs/chip
debootstrap --arch armhf stable chip http://deb.debian.org/debian/
</code></pre>

<h2 id="nfs">NFS</h2>

<p>Pasos sacados de <a href="http://www.chip-community.org/index.php/Booting_a_new_kernel_and_rootfs_via_NFS">aquí</a>.</p>

<p>NFS server:</p>

<pre><code class="language-bash">cat /etc/exports
/nfs/chip 192.168.0.0/16(rw,sync)
</code></pre>

<p>Iniciar el servidor</p>

<pre><code class="language-bash">sudo systemctl restart nfs-server.service
</code></pre>

<h2 id="ips">IPs</h2>

<p>Bootear en Debian de NTC para chequear el servidor NFS.</p>

<p>Cuando conecto la CHIP, me aparece una nueva interfaz de red usb0,
que udev la renombra a enp3s0f0u1 (ver <code>dmesg | tail</code>).</p>

<p>En el server (<em>server~seven~7</em>):</p>

<pre><code class="language-bash">sudo ip addr add 192.168.1.7/24 dev enp3s0f0u1
</code></pre>

<p>En la CHIP (<em>chip~two~2</em>):</p>

<pre><code class="language-bash">sudo ip addr add 192.168.1.2/24 dev usb0
</code></pre>

<p>Chequear ping de una maquina a otra, y si va bien:</p>

<pre><code class="language-bash">sudo mount 192.168.1.7:/nfs/chip tmp/
</code></pre>

<p>Nuestro servidor NFS está andando, ahora sólo hay que compilar nuestro Linux
con soporte usb ethernet (<code>g_ether</code>).</p>

<h2 id="recompilar">Recompilar</h2>

<p>Pasos sacados de <a href="https://developer.ridgerun.com/wiki/index.php/How_to_use_USB_device_networking">aquí</a>.</p>

<p>Activar <code>USB_ETH</code> con <code>menuconfig</code>.</p>

<pre><code class="language-none">Symbol: USB_ETH [=m]
   Prompt: Ethernet Gadget (with CDC Ethernet support)
     Defined at drivers/usb/gadget/Kconfig:628
     Depends on: &lt;choice&gt; &amp;&amp; NET
     Location:
       -&gt; Kernel configuration
         -&gt; Device Drivers
           -&gt; USB support (USB_SUPPORT [=y])
             -&gt; USB Gadget Support (USB_GADGET [=y])
               -&gt; USB Gadget Drivers (&lt;choice&gt; [=m])
</code></pre>

<p>Compilar, copiar y mover como antes.</p>

<h2 id="bootear-posta">Bootear posta</h2>

<p>Reiniciar la CHIP (<code>sudo reboot</code>) y parar U-Boot.</p>

<p>Con setenv definir:</p>

<pre><code class="language-none">setenv g_ether.dev_addr de:ad:be:af:00:01
setenv g_ether.host_addr de:ad:be:af:00:00
setenv ip 192.168.1.2:192.168.1.7::255.255.255.0:chip:usb0:none
setenv nfsroot 192.168.1.7:/nfs/chip

setenv nfsload mtdparts; ubi part UBI; ubifsmount ubi0:rootfs; ubifsload $fdt_addr_r /boot/sun5i-r8-chip-ml.dtb; ubifsload $kernel_addr_r /boot/vmlinuz-$RELEASE
setenv nfsargs setenv bootargs root=/dev/nfs rw nfsroot=${nfsroot},v3 ip=${ip} rootfstype=nfs g_ether.dev_addr=${g_ether.dev_addr} g_ether.host_addr=${g_ether.host_addr} rootwait
setenv nfs_bootcmd &quot;run nfsload ; run nfsargs ; bootz $kernel_addr_r - $fdt_addr_r&quot;
</code></pre>

<blockquote>
<p>Podes guardar las variables permanentemente con <code>saveenv</code>.</p>
</blockquote>

<p>Y finalmente, bootear con:</p>

<pre><code class="language-none">run nfs_bootcmd
</code></pre>

<hr />

<pre><code class="language-none"># uname -a
Linux chip 5.2.0-rc1vv1-gf49aa1de9 #5 SMP Fri May 24 18:07:53 -03 2019 armv7l GNU/Linux
</code></pre>

<p>El log completo se encuentra <a href="/chip-mainline-kernel.log">acá</a>.</p>

        </section>
      </article>

      

      

  </main>
</div>


    
      <footer class="footer">
  <div class="footer__inner">
    <div class="copyright">
      <span>🄯 2019 Powered by <a href="http://gohugo.io">Hugo</a>.</span>
      <span>Made with 🙌 by <a href="https://blog.aidea775.com">AIDEA775</a>.</span>
    </div>
  </div>
</footer>

<script src="https://blog.aidea775.com/assets/menu.js"></script>
<script src="https://blog.aidea775.com/assets/randfavicon.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/components/prism-core.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/autoloader/prism-autoloader.min.js" defer></script>
<script src="https://blog.aidea775.com/assets/main.js" defer ></script>
    
  </div>
</body>
</html>
