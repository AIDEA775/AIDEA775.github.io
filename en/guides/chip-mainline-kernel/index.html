<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Chip Mainline Kernel :: AIDEA775&#39;s Blog</title>
  
  <meta charset="utf-8">
<meta name="description" content="">
<meta name="generator" content="Hugo 0.56.3" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/style.css" type="text/css">
<link rel="stylesheet" href="/css/arst.css" type="text/css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/themes/prism-okaidia.min.css" rel="stylesheet" />
<link rel="alternate" href="/index.xml" type="application/rss+xml" title="AIDEA775&#39;s Blog">
<link id="favicon" rel="icon" href="/favicon.png" type="image/png" sizes="16x16">
<title>Chip Mainline Kernel - AIDEA775&#39;s Blog</title>
</head>
<body>
  <div class="container center">

    
      <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/en">
  <div class="logo">
    AIDEA775
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="about">About</a></li>
              
            
          </ul>
        </ul>
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="about">About</a></li>
      
    
  </ul>
</nav>

  
</header>

    

    

<div class="post">
  <main role="main" class="article">
      <article class="single" itemscope itemtype="http://schema.org/BlogPosting">

        
        <h1 class="post-title headline">
          <a href="https://blog.aidea775.com/en/guides/chip-mainline-kernel/">Chip Mainline Kernel</a>
        </h1>

        <div class="meta">
          
  <span class="key">published on</span>
  <span class="val">
    <time itemprop="datePublished" datetime="2019-08-07">
      August 07, 2019
    </time>
  </span>

          
  <span class="key">in</span>
  <span class="val">
    <a href="https://blog.aidea775.com/en/guides">guides</a>
  </span>


          

          
        </div>

        <section class="body" itemprop="articleBody">
          

<h1 id="caso-base">Caso base:</h1>

<p>La primera vez que alimenté a la CHIP los leds predian, pero no tenía salida
de video. Usé el script de la siguiente guía para flashearla.</p>

<p><a href="http://www.chip-community.org/index.php/Flash_from_command_line#Thore_Krugs_Flasher_Script">http://www.chip-community.org/index.php/Flash_from_command_line#Thore_Krugs_Flasher_Script</a></p>

<p>Otra guía para flashear sin conexión y en español (por Alejandro Gaut):
<a href="https://gitlab.com/snippets/1866690">https://gitlab.com/snippets/1866690</a></p>

<p>Luego de flashearla, los leds empezaron a parpadear,
pero seguía sin video, a prueba y error, descubrí que debía conectar la
salida de audio R del RCA (roja) a la entrada de video (amarrilla).</p>

<p>Una vez que el Debian de NTC booteó, y luego de jugar un buen rato a
<a href="https://www.youtube.com/watch?v=cP1x_EypI6Q">Celeste Classic</a>,
empecé a compilar linux mainline.</p>

<h1 id="si-k-entonces-k-1">Si k, entonces k+1</h1>

<p>Fuente:
<a href="http://www.chip-community.org/index.php/Compile_the_Linux_kernel_for_CHIP">http://www.chip-community.org/index.php/Compile_the_Linux_kernel_for_CHIP</a></p>

<h4 id="compilando">Compilando</h4>

<p>Cross compiling toolchain:</p>

<pre><code class="language-bash">sudo apt-get install gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
</code></pre>

<p>Linux Mainline:</p>

<pre><code class="language-bash">git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
# or
git clone --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
</code></pre>

<p>Kernel config:</p>

<pre><code class="language-bash">cp arch/arm/configs/sunxi_defconfig .config
</code></pre>

<p>Configurar kernel:</p>

<pre><code class="language-bash">make ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf- menuconfig
</code></pre>

<p>No se si esto es tan importante:</p>

<blockquote>
<p>IMPORTANT: add a local version suffix. Follow the menus:</p>

<pre><code class="language-none">    General setup  ---&gt;
    () Local version - append to kernel release
</code></pre>
</blockquote>

<p>Compilar kernel:</p>

<pre><code class="language-bash">make -j13 ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf-
</code></pre>

<blockquote>
<p>El parametro -j debería ser el numero de cores de tu procesador + 1.</p>
</blockquote>

<p>Modulos (tal vez esto no sea necesario):</p>

<pre><code class="language-bash">export WORKSPACE=./build
make ARCH=arm CROSS_COMPILE=/usr/bin/arm-linux-gnueabihf- INSTALL_MOD_PATH=$WORKSPACE modules_install
</code></pre>

<blockquote>
<p>Esto instalará los modulos en $WORKSPACE/lib (después será copiado a la CHIP).</p>
</blockquote>

<h4 id="moviendo">Moviendo</h4>

<blockquote>
<p>Elimina los symlinks <code>build</code> y <code>source</code> de <code>lib/</code> porque <code>[s]cp -r</code> los seguirá.</p>
</blockquote>

<pre><code class="language-bash">export RELEASE=5.2.0-rc1vv1
unlink lib/modules/$RELEASE/build
unlink lib/modules/$RELEASE/source
</code></pre>

<blockquote>
<p>Ahora tendrás que configurar un serivdor ssh en la chip,
no debería ser muy complicado.</p>
</blockquote>

<p>Copiá todo a un directorio temporal a la CHIP:</p>

<pre><code class="language-bash">scp arch/arm/boot/dts/sun5i-r8-chip.dtb chip@192.168.43.21:tmp
scp -r build/lib/modules/$RELEASE arch/arm/boot/zImage .config System.map chip@192.168.43.21:tmp
</code></pre>

<p>Y luego lo movelo a donde corresponda:</p>

<table>
<thead>
<tr>
<th>workspace source location</th>
<th>destination on CHIP</th>
</tr>
</thead>

<tbody>
<tr>
<td>arch/arm/boot/zImage</td>
<td>/boot/vmlinuz-$RELEASE</td>
</tr>

<tr>
<td>.config</td>
<td>/boot/config-$RELEASE</td>
</tr>

<tr>
<td>System.map</td>
<td>/boot/System.map-$RELEASE</td>
</tr>

<tr>
<td>lib/modules/$RELEASE</td>
<td>/lib/modules/$RELEASE</td>
</tr>
</tbody>
</table>

<h4 id="corriendo">Corriendo</h4>

<p>Fuente:
<a href="http://www.chip-community.org/index.php/Chip9$_U-Boot:_how_to_test_a_new_kernel_(in_a_safe_way)#You_need_.28UART1.29_console_access.21">http://www.chip-community.org/index.php/Chip9$_U-Boot:_how_to_test_a_new_kernel_(in_a_safe_way)#You_need_.28UART1.29_console_access.21</a></p>

<p>Necesitamos un cable USB-UART y conectarlo como se debe. (TODO: Agregar foto)</p>

<ul>
<li>Ground pin 1</li>
<li>TX pin 3</li>
<li>RX pin 5</li>
</ul>

<p><strong>CABLE ROJO NO, nada de +5v.</strong></p>

<p>Luego instalar screen:</p>

<pre><code class="language-bash">sudo apt-get install screen
</code></pre>

<p>Conecta el lado del USB a la pc, y lanza screen:</p>

<pre><code class="language-bash">screen /dev/ttyUSB0 115200
</code></pre>

<p>Chequeá la salida de <code>ls /dev/tty*</code> antes y despues de conectar la CHIP para
encontar el archivo correcto.</p>

<blockquote>
<p>Si te sale <code>screen is terminating error</code>, probá con:</p>

<pre><code class="language-bash">sudo screen /dev/ttyUSB0 115200
</code></pre>
</blockquote>

<p>Ahora bootea tu CHIP (conectala a la alimentación).</p>

<h5 id="rapido">Rapido!</h5>

<p>Tenes 3 segundos para parar el proceso de booteo y tener acceso a la shell de u-boot.</p>

<p>(TODO: Agregar log que aparece en pantalla)</p>

<p>Primero intenté bootear directamente:</p>

<p>(TODO: cambiar esto por el comando que setea directamente)</p>

<pre><code class="language-shell">editenv bootcmd
# change `for path in ${bootpaths}; do run boot_$path; done` to `run boot_noinitrd`
editenv boot_noinitrd
# change the path to the kernel image `/boot/zImage` to `/boot/vmlinuz-$RELEASE`
run boot
</code></pre>

<p>Debería tirar kernel panic porque no encuentra un <code>rootfs</code>.
Pero, técnicamente, Linux bootea.</p>

<p>Como la memoria NAND MLC que tiene la CHIP no está soportada en Linux Mainline,
intenté bootear con NFS por usb, en modo usb-device-ethernet.</p>

<h4 id="nfs-rootfs">NFS rootfs</h4>

<p>Fuente:
<a href="http://www.chip-community.org/index.php/Booting_a_new_kernel_and_rootfs_via_NFS">http://www.chip-community.org/index.php/Booting_a_new_kernel_and_rootfs_via_NFS</a></p>

<p>La fuente está realmente mal explicada.</p>

<p>NFS server:</p>

<pre><code class="language-bash">mkdir /nfs/chip
cat /etc/exports
/nfs/chip 192.168.0.0/16(rw,sync)
</code></pre>

<p>Iniciar el servidor</p>

<pre><code class="language-bash">sudo /etc/init.d/nfs-kernel-server restart
</code></pre>

<h5 id="configurar-ips">Configurar IPs:</h5>

<p>Bootear en Debian de NTC para chequear el servidor NFS.</p>

<p>Cuando conecto la CHIP, me aparece una nueva interfaz de red usb0,
que udev la renombra a enp3s0f0u1 (ver <code>dmesg | tail</code>).</p>

<p>En el host (server):</p>

<pre><code class="language-bash">sudo ifconfig enp3s0f0u1 192.168.3.11
</code></pre>

<p>En la CHIP:</p>

<pre><code class="language-bash">sudo /sbin/ifconfig usb0 192.168.3.190
</code></pre>

<p>Chequear ping de una maquina a otra, y si va bien:</p>

<pre><code class="language-bash">sudo mount 192.168.3.11:/nfs/chip tmp/
</code></pre>

<p>Nuestro servidor NFS está andando, ahora sólo hay que compilar Linux con soporte
usb ethernet (<code>g_ether</code>).</p>

<h5 id="recompilar">Recompilar&hellip;</h5>

<p>Fuente: <a href="https://developer.ridgerun.com/wiki/index.php/How_to_use_USB_device_networking">https://developer.ridgerun.com/wiki/index.php/How_to_use_USB_device_networking</a></p>

<p>Activar <code>USB_ETH</code> con <code>make menuconfig</code>.</p>

<pre><code class="language-none">Symbol: USB_ETH [=m]
   Prompt: Ethernet Gadget (with CDC Ethernet support)
     Defined at drivers/usb/gadget/Kconfig:628
     Depends on: &lt;choice&gt; &amp;&amp; NET
     Location:
       -&gt; Kernel configuration
         -&gt; Device Drivers
           -&gt; USB support (USB_SUPPORT [=y])
             -&gt; USB Gadget Support (USB_GADGET [=y])
               -&gt; USB Gadget Drivers (&lt;choice&gt; [=m])
</code></pre>

<p>¿TODO: <code>FEATURE_MOUNT_NFS</code>?</p>

<p>Compilar y mover como antes.</p>

<h5 id="bootear-de-nuevo">Bootear, de nuevo.</h5>

<p>Reiniciar la CHIP (<code>sudo reboot</code>) y parar U-Boot.</p>

<p>Con setenv definir:</p>

<pre><code class="language-none">g_ether.dev_addr=de:ad:be:af:00:01
g_ether.host_addr=de:ad:be:af:00:00
ip=192.168.3.190:192.168.3.11::255.255.255.0:chip:usb0:none
serverip=192.168.3.11
nfsroot=/nfs/chip/

nfsload=mtdparts; ubi part UBI; ubifsmount ubi0:rootfs; ubifsload $fdt_addr_r /boot/sun5i-r8-chip-ml.dtb; ubifsload $kernel_addr_r /boot/vmlinuz-$RELEASE
nfsargs=setenv bootargs root=/dev/nfs rw rootfstype=nfs g_ether.dev_addr=${g_ether.dev_addr} g_ether.host_addr=${g_ether.host_addr} ip=${ip} nfsroot=${serverip}:${nfsroot} rootwait
nfs_bootcmd=run nfsload ; run nfsargs ; bootz $kernel_addr_r - $fdt_addr_r
</code></pre>

<blockquote>
<p>TODO: Comandos para copypastear.</p>
</blockquote>

<p>Podes guardar las variables permanentemente con <code>saveenv</code>.</p>

<p>Y finalmente, bootear con:</p>

<pre><code class="language-none">run nfs_bootcmd
</code></pre>

<hr />

<p>Hasta ahora, sigue tirando kernel panic al no poder cargar el rootfs a través
de NFS. Debo estar configurando algo mal.</p>

<p>Cosas que no probé y no sé si tienen efecto:</p>

<ul>
<li>MAC clonada en el server</li>
</ul>

        </section>
      </article>

      

      

  </main>
</div>


    
      <footer class="footer">
  <div class="footer__inner">
    <div class="copyright">
      <span>🄯 2019 Powered by <a href="http://gohugo.io">Hugo</a>.</span>
      <span>Made with 🙌 by <a href="https://blog.aidea775.com">AIDEA775</a>.</span>
    </div>
  </div>
</footer>

<script src="https://blog.aidea775.com/assets/menu.js"></script>
<script src="https://blog.aidea775.com/assets/randfavicon.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/toolbar/prism-toolbar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
<script src="https://blog.aidea775.com/assets/main.js"></script>
    
  </div>
</body>
</html>
